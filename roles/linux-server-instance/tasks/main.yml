---

  - name: Create Linux Server
    ec2:
      key_name: OctopusVirginia
      instance_type: m3.xlarge
      image: "{{centos_ami}}"
      wait: yes
      wait_timeout: 600
      group: OctopusHttp
      count: 1
      region: us-east-1
      volumes:
        - device_name: /dev/sda1
          volume_size: 80
          volume_type: gp2
          delete_on_termination: true
      instance_tags:
        Appplication: OctopusDeploy
        Domain: None
        Environment: Test
        LifeTime: Permanent
        Name: Octopus Deploy
        OwnerContact: "@matthew.casperson"
        Source: Ansible
    register: linux_server_ec2

  - name: Add Host to Inventory
    add_host:
      name: "{{ linux_server_ec2.instances[0].public_ip }}"
      groups: linux_server

  - name: Wait for SSH to answer on all hosts
    wait_for:
      port: 22
      host: "{{ linux_server_ec2.instances[0].public_ip }}"
      timeout: 600